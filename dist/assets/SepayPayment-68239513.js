import{_ as p,b as h,c as y,e as l,f as o,g as s,y as a,j as i,p as u,G as g}from"./index-7fd2beec.js";const f={data(){return{loading:!0,checking:!1,isPaid:!1,maDonHang:null,paymentData:null,errorMessage:null,timeRemaining:15*60,pollingInterval:null,timerInterval:null,redirectCountdown:3,redirectInterval:null}},computed:{formattedTime(){const e=Math.floor(this.timeRemaining/60),t=this.timeRemaining%60;return`${e.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}},async mounted(){let e=this.$route.query.order||this.$route.params.ma_don_hang;if(e&&(this.maDonHang=e.replace(/\/+$/,"").trim()),!this.maDonHang){this.loading=!1,this.errorMessage="Không tìm thấy mã đơn hàng";return}await this.createPayment(),this.startPolling(),this.startTimer()},beforeUnmount(){this.pollingInterval&&clearInterval(this.pollingInterval),this.timerInterval&&clearInterval(this.timerInterval),this.redirectInterval&&clearInterval(this.redirectInterval)},methods:{async createPayment(){try{const t=JSON.parse(localStorage.getItem("pending_order")||"{}").tien_thuc_nhan||0,d=await h.post("/payment/sepay/create",{ma_don_hang:this.maDonHang,so_tien:t});d.data.status?this.paymentData=d.data.data:this.errorMessage=d.data.message||"Không thể tạo thanh toán"}catch(e){console.error("Create payment error:",e),await this.getQrCode()}finally{this.loading=!1}},async getQrCode(){try{const e=await h.get(`/payment/sepay/qr/${this.maDonHang}`);e.data.status?this.paymentData=e.data.data:this.errorMessage=e.data.message}catch{this.errorMessage="Không thể tải mã QR"}},startPolling(){this.pollingInterval=setInterval(()=>{this.checkPaymentStatus()},5e3)},startTimer(){this.timerInterval=setInterval(()=>{this.timeRemaining>0?this.timeRemaining--:(clearInterval(this.timerInterval),clearInterval(this.pollingInterval),this.errorMessage="Hết thời gian thanh toán. Vui lòng thử lại.",this.paymentData=null)},1e3)},async checkPaymentStatus(){try{const e=`/payment/sepay/status/${this.maDonHang}`;console.log("Checking payment status at:",e);const t=await h.get(e);t.data.status&&t.data.data.is_paid&&(this.isPaid=!0,clearInterval(this.pollingInterval),clearInterval(this.timerInterval),localStorage.removeItem("pending_order"),window.dispatchEvent(new Event("payment-completed")),this.$toast.success("Thanh toán thành công!"),this.startRedirectTimer())}catch(e){console.error("Check status error:",e)}},async checkPaymentManual(){this.checking=!0,await this.checkPaymentStatus(),this.isPaid||this.$toast.info("Chưa nhận được thanh toán. Vui lòng đợi hoặc kiểm tra lại giao dịch."),this.checking=!1},copyText(e){navigator.clipboard.writeText(e).then(()=>{this.$toast.success("Đã copy: "+e)}).catch(()=>{this.$toast.error("Không thể copy")})},startRedirectTimer(){this.redirectInterval=setInterval(()=>{this.redirectCountdown>1?this.redirectCountdown--:(clearInterval(this.redirectInterval),this.$router.push("/lich-su-don-hang"))},1e3)}}},v={class:"container py-5"},b={class:"card shadow-lg mx-auto",style:{"max-width":"500px"}},x={class:"card-body text-center p-4"},k={key:0,class:"py-5"},_={key:1,class:"py-4"},w={class:"text-muted mb-4"},I={class:"text-primary"},D={class:"alert alert-info py-2 mb-4"},C={key:2},T={class:"alert alert-warning d-flex align-items-center mb-4",role:"alert"},P={class:"qr-wrapper mb-4 p-3 bg-white rounded-3 shadow-sm d-inline-block"},S=["src"],M={class:"transfer-info bg-light rounded-3 p-3 text-start mb-4"},R={class:"row g-2"},H={class:"col-7 fw-bold text-primary"},Q={class:"col-7 fw-bold"},q={class:"col-7 fw-bold"},N={class:"col-7 fw-bold text-danger fs-5"},V={class:"col-7 fw-bold text-success"},K={class:"d-grid gap-2"},B=["disabled"],E={key:0},z={key:1},X={key:3,class:"py-4"},j={class:"text-danger mt-3"};function G(e,t,d,J,n,r){const c=y("router-link");return l(),o("div",v,[s("div",b,[t[28]||(t[28]=s("div",{class:"card-header text-center py-3",style:{background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"}},[s("h4",{class:"mb-0 text-white"},[s("i",{class:"fa-solid fa-qrcode me-2"}),a(" Thanh toán qua SePay ")])],-1)),s("div",x,[n.loading?(l(),o("div",k,[...t[3]||(t[3]=[s("div",{class:"spinner-border text-primary",style:{width:"3rem",height:"3rem"}},null,-1),s("p",{class:"text-muted mt-3"},"Đang tạo mã QR...",-1)])])):n.isPaid?(l(),o("div",_,[t[10]||(t[10]=s("div",{class:"success-animation mb-4"},[s("i",{class:"fa-solid fa-circle-check text-success",style:{"font-size":"80px"}})],-1)),t[11]||(t[11]=s("h3",{class:"text-success fw-bold mb-3"},"Thanh toán thành công!",-1)),s("p",w,[t[4]||(t[4]=a(" Đơn hàng ",-1)),s("b",I,i(n.maDonHang),1),t[5]||(t[5]=a(" đã được xác nhận. ",-1))]),s("div",D,[t[6]||(t[6]=s("i",{class:"fa-solid fa-circle-info me-2"},null,-1)),t[7]||(t[7]=a(" Hệ thống sẽ tự động chuyển hướng sau ",-1)),s("b",null,i(n.redirectCountdown),1),t[8]||(t[8]=a(" giây... ",-1))]),u(c,{to:"/lich-su-don-hang",class:"btn btn-success btn-lg px-4"},{default:g(()=>[...t[9]||(t[9]=[s("i",{class:"fa-solid fa-clipboard-list me-2"},null,-1),a(" Xem đơn hàng ",-1)])]),_:1})])):n.paymentData?(l(),o("div",C,[s("div",T,[t[13]||(t[13]=s("i",{class:"fa-solid fa-clock me-2"},null,-1)),s("span",null,[t[12]||(t[12]=a("Thời gian còn lại: ",-1)),s("b",null,i(r.formattedTime),1)])]),s("div",P,[s("img",{src:n.paymentData.qr_url,alt:"QR Code VietQR",style:{width:"250px",height:"250px"},class:"rounded"},null,8,S)]),s("div",M,[t[21]||(t[21]=s("h6",{class:"text-center text-muted mb-3"},[s("i",{class:"fa-solid fa-building-columns me-2"}),a(" Thông tin chuyển khoản ")],-1)),s("div",R,[t[16]||(t[16]=s("div",{class:"col-5 text-muted"},"Ngân hàng:",-1)),s("div",H,i(n.paymentData.bank_name),1),t[17]||(t[17]=s("div",{class:"col-5 text-muted"},"Số tài khoản:",-1)),s("div",Q,[a(i(n.paymentData.bank_account)+" ",1),s("button",{class:"btn btn-sm btn-outline-secondary ms-2",onClick:t[0]||(t[0]=m=>r.copyText(n.paymentData.bank_account))},[...t[14]||(t[14]=[s("i",{class:"fa-regular fa-copy"},null,-1)])])]),t[18]||(t[18]=s("div",{class:"col-5 text-muted"},"Chủ tài khoản:",-1)),s("div",q,i(n.paymentData.bank_account_name),1),t[19]||(t[19]=s("div",{class:"col-5 text-muted"},"Số tiền:",-1)),s("div",N,i(n.paymentData.so_tien_format),1),t[20]||(t[20]=s("div",{class:"col-5 text-muted"},"Nội dung CK:",-1)),s("div",V,[a(i(n.paymentData.noi_dung_chuyen_khoan)+" ",1),s("button",{class:"btn btn-sm btn-outline-secondary ms-2",onClick:t[1]||(t[1]=m=>r.copyText(n.paymentData.noi_dung_chuyen_khoan))},[...t[15]||(t[15]=[s("i",{class:"fa-regular fa-copy"},null,-1)])])])])]),t[25]||(t[25]=s("div",{class:"alert alert-info text-start mb-4"},[s("h6",{class:"mb-2"},[s("i",{class:"fa-solid fa-lightbulb me-2"}),a("Hướng dẫn:")]),s("ol",{class:"mb-0 ps-3"},[s("li",null,"Mở app ngân hàng và quét mã QR"),s("li",null,"Kiểm tra thông tin và số tiền"),s("li",null,"Nhập đúng nội dung chuyển khoản"),s("li",null,"Xác nhận thanh toán")])],-1)),s("div",K,[s("button",{class:"btn btn-primary btn-lg",onClick:t[2]||(t[2]=(...m)=>r.checkPaymentManual&&r.checkPaymentManual(...m)),disabled:n.checking},[n.checking?(l(),o("span",E,[...t[22]||(t[22]=[s("span",{class:"spinner-border spinner-border-sm me-2"},null,-1),a(" Đang kiểm tra... ",-1)])])):(l(),o("span",z,[...t[23]||(t[23]=[s("i",{class:"fa-solid fa-rotate me-2"},null,-1),a(" Tôi đã thanh toán ",-1)])]))],8,B),u(c,{to:"/lich-su-don-hang",class:"btn btn-outline-secondary"},{default:g(()=>[...t[24]||(t[24]=[s("i",{class:"fa-solid fa-arrow-left me-2"},null,-1),a(" Quay lại ",-1)])]),_:1})])])):(l(),o("div",X,[t[27]||(t[27]=s("i",{class:"fa-solid fa-triangle-exclamation text-danger",style:{"font-size":"60px"}},null,-1)),s("h5",j,i(n.errorMessage),1),u(c,{to:"/",class:"btn btn-primary mt-3"},{default:g(()=>[...t[26]||(t[26]=[s("i",{class:"fa-solid fa-home me-2"},null,-1),a(" Về trang chủ ",-1)])]),_:1})]))])])])}const U=p(f,[["render",G],["__scopeId","data-v-39774720"]]);export{U as default};
